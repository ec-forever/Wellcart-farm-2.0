<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Onboard Retailer</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.13/dist/tailwind.min.css"
    />
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useState } = React;

      const Input = ({ label, ...props }) => (
        <label className="block space-y-1 text-sm font-medium text-gray-700">
          <span>{label}</span>
          <input
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-lime-400 focus:outline-none focus:ring-2 focus:ring-lime-200"
            {...props}
          />
        </label>
      );

      const OnboardForm = () => {
        const [formState, setFormState] = useState({
          store_name: "",
          address: "",
          contact_name: "",
          contact_phone: "",
          contact_email: "",
        });
        const [logoFile, setLogoFile] = useState(null);
        const [status, setStatus] = useState(null);

        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormState((prev) => ({ ...prev, [name]: value }));
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          setStatus("Submitting...");
          try {
            const body = new FormData();
            Object.entries(formState).forEach(([key, value]) => body.append(key, value));
            if (logoFile) body.append("logo", logoFile);

            const response = await fetch("/api/retailer", {
              method: "POST",
              body,
            });

            if (!response.ok) throw new Error("Failed to create retailer");

            const data = await response.json();
            const retailerId = data.id || data.retailer_id || data.retailerId;
            if (retailerId) {
              window.location.href = `/upload.html?retailer_id=${retailerId}`;
            } else {
              setStatus("Retailer created but no ID returned.");
            }
          } catch (err) {
            console.error(err);
            setStatus("Submission failed. Please try again.");
          }
        };

        return (
          <form
            onSubmit={handleSubmit}
            className="mx-auto max-w-2xl space-y-6 rounded-2xl bg-white p-8 shadow-lg"
          >
            <div className="space-y-2">
              <h1 className="text-3xl font-bold text-gray-900">Retailer intake</h1>
              <p className="text-gray-600">
                Provide store and contact information to start uploading products.
              </p>
            </div>

            <Input
              label="Store name"
              name="store_name"
              value={formState.store_name}
              onChange={handleChange}
              required
            />
            <Input
              label="Address"
              name="address"
              value={formState.address}
              onChange={handleChange}
              required
            />

            <div className="grid gap-4 sm:grid-cols-2">
              <Input
                label="Contact name"
                name="contact_name"
                value={formState.contact_name}
                onChange={handleChange}
                required
              />
              <Input
                label="Contact phone"
                name="contact_phone"
                value={formState.contact_phone}
                onChange={handleChange}
                required
              />
            </div>

            <Input
              label="Contact email"
              name="contact_email"
              type="email"
              value={formState.contact_email}
              onChange={handleChange}
              required
            />

            <label className="block space-y-1 text-sm font-medium text-gray-700">
              <span>Logo</span>
              <input
                type="file"
                accept="image/*"
                onChange={(e) => setLogoFile(e.target.files[0])}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-lime-400 focus:outline-none focus:ring-2 focus:ring-lime-200"
              />
            </label>

            <button
              type="submit"
              className="w-full rounded-lg bg-lime-400 px-4 py-3 text-lg font-semibold text-gray-900 shadow-md transition hover:bg-lime-300"
            >
              Continue
            </button>

            {status && <p className="text-center text-sm text-gray-600">{status}</p>}
          </form>
        );
      };

      const Layout = () => (
        <div className="min-h-screen bg-gradient-to-br from-lime-50 via-white to-green-50 px-4 py-10">
          <OnboardForm />
        </div>
      );

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<Layout />);
    </script>
  </body>
</html>
